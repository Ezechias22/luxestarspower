<?php
header('Content-Type: application/xml; charset=utf-8');
error_reporting(0);
ini_set('display_errors', 0);

require_once __DIR__ . '/../vendor/autoload.php';
use App\Database;

$products = [];
$shops = [];

try {
    $db = Database::getInstance();
    $products = $db->fetchAll("SELECT slug, updated_at FROM products WHERE is_active = 1 AND (status IS NULL OR status != 'rejected') ORDER BY updated_at DESC");
    $shops = $db->fetchAll("SELECT shop_slug, updated_at FROM users WHERE role = 'seller' AND shop_slug IS NOT NULL AND shop_slug != ''");
} catch (Exception $e) {}

// Nettoie l'output buffer
if (ob_get_level()) ob_end_clean();
ob_start();
?>
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
<?php foreach ($products as $p): if (empty($p['slug'])) continue; ?>
  <url>
    <loc><?php echo 'https://luxestarspower.com/produit/' . htmlspecialchars($p['slug'], ENT_XML1, 'UTF-8'); ?></loc>
    <lastmod><?php echo $p['updated_at'] ? date('Y-m-d', strtotime($p['updated_at'])) : date('Y-m-d'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
<?php endforeach; ?>
<?php foreach ($shops as $s): if (empty($s['shop_slug'])) continue; ?>
  <url>
    <loc><?php echo 'https://luxestarspower.com/boutique/' . htmlspecialchars($s['shop_slug'], ENT_XML1, 'UTF-8'); ?></loc>
    <lastmod><?php echo $s['updated_at'] ? date('Y-m-d', strtotime($s['updated_at'])) : date('Y-m-d'); ?></lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.7</priority>
  </url>
<?php endforeach; ?>
</urlset>
<?php
$output = ob_get_clean();
echo trim($output);