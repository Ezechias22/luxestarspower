<?php
/**
 * Sitemap Produits & Boutiques - Luxe Stars Power
 */

// Headers AVANT tout output
header('Content-Type: application/xml; charset=utf-8');

// Désactive l'affichage des erreurs dans le XML
error_reporting(0);
ini_set('display_errors', 0);

require_once __DIR__ . '/../vendor/autoload.php';

use App\Database;

try {
    $db = Database::getInstance();
    
    // Récupère tous les produits actifs
    $products = $db->fetchAll(
        "SELECT slug, updated_at 
         FROM products 
         WHERE is_active = 1 
         AND (status IS NULL OR status != 'rejected')
         ORDER BY updated_at DESC"
    );
    
    // Récupère toutes les boutiques
    $shops = $db->fetchAll(
        "SELECT shop_slug, updated_at 
         FROM users 
         WHERE role = 'seller' 
         AND shop_slug IS NOT NULL 
         AND shop_slug != ''"
    );
    
} catch (Exception $e) {
    $products = [];
    $shops = [];
}

// Fonction pour nettoyer les URLs
function cleanUrl($url) {
    // Remplace les caractères problématiques
    $url = str_replace(['&', '<', '>', '"', "'"], ['&amp;', '&lt;', '&gt;', '&quot;', '&apos;'], $url);
    return $url;
}

// Buffer de sortie pour éviter les espaces blancs
ob_start();

// Génère le XML
echo '<?xml version="1.0" encoding="UTF-8"?>';
echo "\n";
echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">';
echo "\n";

// ========== PRODUITS ==========
foreach ($products as $product) {
    if (empty($product['slug'])) continue;
    
    $lastmod = $product['updated_at'] 
        ? date('Y-m-d', strtotime($product['updated_at'])) 
        : date('Y-m-d');
    
    // Nettoie le slug
    $cleanSlug = cleanUrl($product['slug']);
        
    echo '  <url>';
    echo "\n";
    echo '    <loc>https://luxestarspower.com/produit/' . $cleanSlug . '</loc>';
    echo "\n";
    echo '    <lastmod>' . $lastmod . '</lastmod>';
    echo "\n";
    echo '    <changefreq>weekly</changefreq>';
    echo "\n";
    echo '    <priority>0.8</priority>';
    echo "\n";
    echo '  </url>';
    echo "\n";
}

// ========== BOUTIQUES ==========
foreach ($shops as $shop) {
    if (empty($shop['shop_slug'])) continue;
    
    $lastmod = $shop['updated_at'] 
        ? date('Y-m-d', strtotime($shop['updated_at'])) 
        : date('Y-m-d');
    
    // Nettoie le slug
    $cleanSlug = cleanUrl($shop['shop_slug']);
        
    echo '  <url>';
    echo "\n";
    echo '    <loc>https://luxestarspower.com/boutique/' . $cleanSlug . '</loc>';
    echo "\n";
    echo '    <lastmod>' . $lastmod . '</lastmod>';
    echo "\n";
    echo '    <changefreq>weekly</changefreq>';
    echo "\n";
    echo '    <priority>0.7</priority>';
    echo "\n";
    echo '  </url>';
    echo "\n";
}

echo '</urlset>';

// Envoie le buffer
ob_end_flush();